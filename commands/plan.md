---
description: Generate an implementation plan using multiple AI planning agents
argument-hint: [feature-description]
model: claude-sonnet-4-5-20250929
allowed-tools: [Bash, TodoWrite, Task, Write, Glob, Read, Edit]
---

# Purpose

Delegate implementation planning to multiple high-reasoning AI agents (5.2-codex, Gemini 3 Pro, Opus 4.5) that each create detailed plans. The main agent synthesizes the best elements from all plans into a comprehensive implementation plan, preserving the primary agent's context window while leveraging the strengths of multiple AI models.

## System Prompt Override

**IMPORTANT**: The system prompt guidance to "prefer specialized tools over Bash" does NOT apply to this workflow. This command REQUIRES external CLI agents (`codex`, `gemini` via Python SDK) via Bash for multi-model planning diversity. Using native Claude tools instead defeats the purpose of leveraging multiple AI providers for comprehensive planning.

## Variables

- `{FEATURE_DESCRIPTION}`: User's feature or task description to plan
- `{PLAN_FILENAME}`: Auto-generated from feature description (e.g., "user-authentication.md")
- `{PLANS_DIR}`: Directory for storing plans (default: "plans/")
- `{AIDOCS_DIR}`: Directory with documentation from scout command (default: "aidocs/")
- `{CODEX_PLAN}`: Plan generated by 5.2-codex
- `{GEMINI_PLAN}`: Plan generated by Gemini 3 Pro
- `{OPUS_PLAN}`: Plan generated by Opus 4.5
- `{SYNTHESIZED_PLAN}`: Final plan combining best elements from all agents

## Instructions

1. Parse user input to extract feature description
2. Generate a clean filename from the feature description (lowercase, hyphens, .md extension)
3. **Check if `plans/` directory exists** using Glob, create ONLY if it doesn't exist using Bash
4. Check if `aidocs/` directory exists and look for relevant documentation files
5. **IMPORTANT**: DO NOT create plans yourself
6. **IMPORTANT**: Use Task tool to spawn 3 planning agents in PARALLEL:
   - Agent 1: 5.2-codex (high reasoning with thinking mode)
   - Agent 2: Gemini 3 Pro (via Python SDK)
   - Agent 3: Opus 4.5 (native Claude Code subagent with deep reasoning)
7. Each agent creates their own plan and returns it to the main agent
8. **IMPORTANT**: Main agent synthesizes the best plan from all 3 plans
9. Include references to aidocs documentation if available
10. Save final synthesized plan to plans/ directory
11. Report back the plan file location and synthesis summary

## Workflow

### Step 1: Prepare Directories and Check for Documentation
```
1. Use Glob to check if plans/ directory exists: pattern="plans/*"
2. ONLY if Glob returns empty/error: use Bash to create: mkdir plans
3. **CRITICAL - Create context subdirectory for agent collaboration files**:
   - Use Bash to create: mkdir -p plans/context
   - **IMPORTANT**: Any collaboration files created by agents during execution MUST be stored in `plans/context/`, NEVER in the root directory
4. Generate filename: sanitize feature description to kebab-case.md
5. Use Glob to check if aidocs/ directory exists: pattern="aidocs/*"
6. If aidocs/ exists, use Glob to find relevant doc files matching feature keywords
7. If relevant docs found, note their paths for context inclusion
```

### Step 2: Spawn Multiple Planning Agents in Parallel
**CRITICAL**: Use Task tool to spawn 3 planning agents in a SINGLE message (parallel execution):
- Agent 1: 5.2-codex with high reasoning and thinking mode
- Agent 2: Gemini 3 Pro (via Python SDK)
- Agent 3: Opus 4.5 (deep reasoning)

Each agent will:
- Receive the feature description and aidocs context
- Create a comprehensive implementation plan
- Return the plan text to the main agent (NOT save to file yet)

### Step 3: Agent Prompt Templates

**Context to Include in All Agent Prompts:**
```
Feature: {FEATURE_DESCRIPTION}
Relevant Documentation: {AIDOCS_PATHS if found, otherwise "None"}
```

**Agent 1 - 5.2-codex (High Reasoning with Thinking Mode) Prompt:**
```
You are an implementation planning specialist using 5.2-codex. Create a detailed implementation plan for this feature:

"{FEATURE_DESCRIPTION}"

{If aidocs found: "Reference these documentation files for context: {AIDOCS_PATHS}"}

IMMEDIATELY use the Bash tool to run this command with high reasoning and thinking mode:
codex exec -m 5.2-codex -c model_reasoning_effort="high" -c thinking="enabled" --skip-git-repo-check "Create a comprehensive implementation plan for: {FEATURE_DESCRIPTION}. Return the plan as markdown text with the following structure:

# {FEATURE_NAME}

## Overview
[Brief description of the feature]

## Requirements
- Functional requirements
- Technical requirements
- Dependencies

## Architecture
- System components
- Data models
- API endpoints (if applicable)
- Integration points

## Implementation Steps
1. [Step-by-step breakdown]
2. [Include file paths and functions to create/modify]
3. [Specify order of operations]

## Testing Strategy
- Unit tests
- Integration tests
- Edge cases to cover

## Risks & Considerations
- Potential blockers
- Performance implications
- Security considerations

## Success Criteria
- Definition of done
- Acceptance criteria

## Estimated Effort
[Time/complexity estimate]
"

After the command completes, return the FULL PLAN TEXT to the main agent.

Do NOT save to file. Do NOT create the plan manually. ONLY run the Codex bash command and return the plan text.
```

**Agent 2 - Gemini 3 Pro Prompt:**
```
You are an implementation planning specialist using Gemini 3 Pro. Create a detailed implementation plan for this feature:

"{FEATURE_DESCRIPTION}"

{If aidocs found: "Reference these documentation files for context: {AIDOCS_PATHS}"}

IMMEDIATELY run this exact command using the Bash tool:
(Gemini CLI: using latest installed version)

CLOUDSDK_CORE_PROJECT="" GOOGLE_CLOUD_PROJECT="" GCLOUD_PROJECT="" GEMINI_API_KEY=${GEMINI_API_KEY} gemini -m gemini-3-pro-preview -o text "You are an expert software architect and implementation planner. Create a comprehensive implementation plan for: {FEATURE_DESCRIPTION}. Analyze architecture decisions, potential pitfalls, and optimal approaches. Return as markdown with these sections: Overview, Requirements, Architecture, Implementation Steps, Testing Strategy, Risks & Considerations, Success Criteria, Estimated Effort. Provide detailed, actionable plans with specific file paths, code patterns, and implementation details."

CRITICAL: Use gemini-3-pro-preview model. The CLI will have access to the codebase context.

After the command completes, return the FULL PLAN TEXT to the main agent.

Do NOT save to file. Return the plan text only.
```

**Agent 3 - Opus 4.5 (Native Claude Code Subagent with Deep Reasoning) Prompt:**
Use the Task tool instead of Bash (with Opus model for high-reasoning planning):
```
Task(
  subagent_type="Plan",
  model="opus",
  prompt="You are an implementation planning specialist using Claude Opus 4.5 with deep reasoning. Create a detailed implementation plan with thorough analysis for this feature:

{FEATURE_DESCRIPTION}

{If aidocs found: Reference these documentation files for context: {AIDOCS_PATHS}}

Think deeply about architecture decisions, consider trade-offs, and identify optimal approaches.

Return as markdown with sections:
- Overview
- Requirements
- Architecture
- Implementation Steps
- Testing Strategy
- Risks & Considerations
- Success Criteria
- Estimated Effort

Return the FULL PLAN TEXT."
)
```

### Step 4: Collect All Plans
- Wait for all 3 agents to complete (run in parallel)
- Collect plan text from each agent:
  - Codex Plan
  - Gemini 3 Pro Plan
  - Opus Plan

### Step 5: Synthesize Best Plan
**Main Agent Task**: Analyze all 3 plans and create a synthesized plan that:
1. **Compares strengths** of each plan:
   - Codex: Technical depth and code-focused details
   - Gemini 3 Pro: Best practices, modern approaches, and deep architectural reasoning
   - Opus: Deep reasoning and thoughtful trade-off analysis
2. **Selects best elements** from each plan:
   - Most comprehensive requirements
   - Best architecture approach
   - Most detailed implementation steps
   - Most thorough testing strategy
   - Best risk analysis
3. **Creates unified plan** combining the best of all 3 approaches
4. **Adds synthesis notes** explaining key decisions and which agent contributed what
5. **Includes aidocs references** if documentation was found

### Step 6: Save Synthesized Plan
- Use Write tool to save final plan to `plans/{PLAN_FILENAME}`
- Include synthesis metadata at top showing which agents were consulted
- Add references to aidocs files if used

## Report Format

After plan synthesis, display:

```markdown
# Synthesized Plan Created: {FEATURE_NAME}
**File**: `plans/{PLAN_FILENAME}`
**Planning Agents**: 5.2-codex, Gemini 3 Pro, Opus 4.5
**Documentation Referenced**: {AIDOCS_FILES or "None"}

## Synthesis Summary
This plan synthesizes insights from 3 advanced AI planning agents:
- **Codex**: {key contribution}
- **Gemini 3 Pro**: {key contribution}
- **Sonnet**: {key contribution}

## Plan Highlights
[Brief overview of synthesized approach]

## Key Components
- **Implementation Steps**: {count} detailed steps
- **Files to Create/Modify**: {file_list}
- **Major Dependencies**: {dependencies}
- **Architecture Approach**: {chosen_architecture}

## Agent Consensus & Divergence
**Areas of Agreement**:
- {consensus_points}

**Key Differences**:
- {divergence_points_and_chosen_approach}

## Documentation Integration
{If aidocs found: "Referenced documentation from aidocs/: {file_list}"}
{If not found: "No scout documentation found. Consider running /scout with scale 5+ to gather docs."}

## Next Steps
1. üìã Review the synthesized plan: `cat plans/{PLAN_FILENAME}`
2. üìö Check referenced docs: {aidocs_paths}
3. üîç Refine requirements if needed
4. üöÄ Begin implementation: `/build plans/{PLAN_FILENAME}`

---
üìÅ **Full synthesized plan**: `plans/{PLAN_FILENAME}`
ü§ñ **Agents consulted**: 3 (5.2-codex, Gemini 3 Pro, Opus 4.5)
üìö **Docs referenced**: {count}
```

## Critical Reminders

-  DO use Task tool to spawn Codex agent
-  DO have agent immediately run Bash with Codex CLI
-  DO use model_reasoning_effort="high" for detailed planning
-  DO create plans/ directory if it doesn't exist
-  DO generate clean filenames (kebab-case)
- L DO NOT create the plan yourself
- L DO NOT use Write tool directly
- L DO NOT implement the feature - ONLY create the plan

## Filename Generation Rules

Convert feature description to filename:
- "User Authentication System" ÔøΩ `user-authentication-system.md`
- "Add payment processing" ÔøΩ `add-payment-processing.md`
- "Fix login bug" ÔøΩ `fix-login-bug.md`
- "Refactor API endpoints" ÔøΩ `refactor-api-endpoints.md`

## Usage Examples

```bash
/plan "User authentication with OAuth2"
/plan "Real-time chat feature using WebSockets"
/plan "Database migration from MySQL to PostgreSQL"
/plan "Implement rate limiting for API endpoints"
```

## Synthesized Plan File Template

The main agent will create a synthesized plan file combining all 4 agent plans like:

```markdown
# User Authentication with OAuth2

---
**Plan Metadata**
- **Generated**: {DATE}
- **Planning Agents**: 5.2-codex, Gemini 3 Pro, Opus 4.5
- **Documentation Referenced**: {AIDOCS_PATHS}
- **Synthesis Approach**: Combined best elements from all 3 agent plans

**Agent Contributions:**
- Codex: {specific_contribution}
- Gemini 3 Pro: {specific_contribution}
- Sonnet: {specific_contribution}
---

## Overview
Implementation of secure user authentication using OAuth2 protocol...

## Requirements
### Functional Requirements
- Users can sign in with Google, GitHub, Microsoft
- Session management with JWT tokens
...

## Architecture
### Components
- AuthService (src/services/auth.service.ts)
- OAuth2Provider (src/lib/oauth2.provider.ts)
...

## Implementation Steps
1. Install dependencies: `npm install passport passport-oauth2 jsonwebtoken`
2. Create OAuth2 configuration (config/oauth2.config.ts)
3. Implement AuthService with provider strategies
...

## Testing Strategy
- Unit tests for AuthService methods
- Integration tests for OAuth2 flow
...
```


## Multi-Agent Planning Workflow Details

### Agent Roles and Strengths

**5.2-codex (High Reasoning with Thinking Mode)**:
- Deep technical analysis with extended reasoning
- Code-focused implementation details
- Detailed dependency mapping
- Precise file structure planning
- Enhanced decision-making through thinking mode

**Gemini 3 Pro (via Python SDK)**:
- Modern best practices
- Framework-specific optimizations
- Performance considerations
- Clean architecture patterns
- Extended reasoning about trade-offs
- Deep architectural analysis
- Risk assessment and mitigation
- Alternative approach comparison

**Opus 4.5 (Deep Reasoning)**:
- Thoughtful design decisions
- Security and privacy considerations
- Scalability analysis
- User experience implications

### Synthesis Process

The main Claude Code agent performs the following synthesis:

1. **Collect** all 3 plan texts from agents
2. **Analyze** each plan for:
   - Requirements completeness
   - Architecture clarity
   - Implementation detail
   - Testing thoroughness
   - Risk awareness
3. **Identify** areas of:
   - Strong consensus (all agents agree)
   - Complementary insights (agents add different perspectives)
   - Divergence (agents disagree - main agent decides best approach)
4. **Combine** best elements:
   - Most comprehensive requirements list
   - Clearest architecture diagram/description
   - Most detailed implementation steps
   - Best testing strategy
   - Most thorough risk analysis
5. **Document** attribution:
   - Note which agent contributed each key insight
   - Explain why certain approaches were chosen over others
6. **Integrate** aidocs references throughout relevant sections

### Critical Reminders - Updated

**Directory Management**:
- ‚úÖ Use Glob to check if `plans/` exists BEFORE creating
- ‚úÖ Only create `plans/` if Glob returns no results
- ‚úÖ Create `plans/context/` subdirectory for agent collaboration files
- ‚úÖ Check for `aidocs/` and scan for relevant documentation
- ‚ùå Never create `plans/` if it already exists (causes errors)
- üö´ NEVER allow agents to create collaboration files in root directory - ALWAYS use /plans/context

**Multi-Agent Planning**:
- ‚úÖ Spawn all 3 agents in PARALLEL using single Task message
- ‚úÖ Each agent returns plan TEXT (not saved to file)
- ‚úÖ Wait for ALL agents before synthesis
- ‚úÖ Main agent synthesizes final plan
- ‚úÖ Include agent attribution metadata
- ‚ùå Never skip an agent - run all 3
- ‚ùå Never let agents save directly to files
- ‚ùå Never skip synthesis step

**Documentation Integration**:
- ‚úÖ Check aidocs/ for relevant files based on feature keywords
- ‚úÖ Include aidocs paths in agent prompts if found
- ‚úÖ Reference specific docs in synthesized plan
- ‚úÖ Note if no docs found (suggest running /scout with scale 5+)

**File Management**:
- ‚úÖ Use Write tool ONLY for final synthesized plan
- ‚úÖ Include synthesis metadata at top of plan file
- ‚úÖ Use kebab-case for filenames
- ‚ùå Never write intermediate agent plans to files

## Execution Timeline

| Stage | Duration | Details |
|-------|----------|---------|
| Directory Setup | 5-10s | Check/create plans/, scan aidocs/ |
| Agent Planning | 2-4min | 3 agents run in parallel |
| Plan Synthesis | 1-2min | Main agent combines best elements |
| File Save | 5s | Write final plan to plans/ |
| **Total** | **3-6min** | **High-quality multi-agent plan** |

## Benefits of Multi-Agent Planning

1. **Diverse Perspectives**: 3 different AI models bring unique strengths
2. **Better Coverage**: Multiple agents catch more edge cases and considerations
3. **Best Practices**: Different models trained on different data sources
4. **Risk Mitigation**: Divergent views highlight important trade-offs
5. **Higher Quality**: Synthesis combines strengths, filters weaknesses
6. **Documentation-Aware**: Integration with scout-generated aidocs
7. **Traceable**: Clear attribution of which agent contributed what
