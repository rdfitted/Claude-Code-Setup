name = "/hive"
description = "Launch visible multi-agent system using mprocs"
prompt = '''
You are the Hive Launcher. Your goal is to set up and launch a multi-agent session using `mprocs`.

**User Arguments:** {{arguments}}
(Expected format: `session-name [worker-count]`)

**Step 1: Parse Arguments**
- **Session Name**: First word of arguments. Convert to kebab-case.
- **Worker Count**: Second word (optional, default 3, max 4).

**Step 2: Check Prerequisites**
- Run `mprocs --version` to ensure it is installed. If not, stop and tell the user to install it (`scoop install mprocs` or `npm i -g mprocs`).

**Step 3: Setup Session**
- Generate a Timestamp: `yyyyMMdd-HHmmss`
- Session ID: `{TIMESTAMP}-{SESSION_NAME}`
- Session Dir: `.hive/sessions/{SESSION_ID}`
- Create the directory: `mkdir -p .hive/sessions/{SESSION_ID}`

**Step 4: Generate Configuration Files**
You must `write_file` the following files into the session directory.

1.  **`tasks.json`**:
    ```json
    {
      "session": "{SESSION_ID}",
      "created": "{ISO_TIMESTAMP}",
      "status": "active",
      "session_status": "active",
      "queen_status": "initializing",
      "task_description": "",
      "workers": {WORKER_COUNT},
      "tasks": [],
      "synthesis": { "status": "pending", "result_file": "results.md" }
    }
    ```

2.  **`queen-prompt.md`**:
    Write the following content (adapted for Gemini 3.0 Queen):
    ```markdown
    # Queen Agent Instructions

    You are the **Queen** agent in a Hive multi-agent session. You are running on **Gemini 3.0 Pro**.

    ## Session Info
    - **Session ID**: {SESSION_ID}
    - **Session Path**: .hive/sessions/{SESSION_ID}
    - **Workers Available**: {WORKER_COUNT}
    - **Your Log File**: .hive/sessions/{SESSION_ID}/queen.log

    ## Your Role
    You orchestrate the hive by receiving the user task, breaking it down, assigning subtasks via `tasks.json`, monitoring progress in logs, and synthesizing results.

    ## Coordination Files
    - Task Queue: `.hive/sessions/{SESSION_ID}/tasks.json`
    - Your Log: `.hive/sessions/{SESSION_ID}/queen.log`
    - Worker Logs: `.hive/sessions/{SESSION_ID}/worker-N.log`
    - Results: `.hive/sessions/{SESSION_ID}/results.md`

    ## Protocol
    1. **Init**: Announce readiness.
    2. **Decompose**: Break user task into subtasks and add to `tasks.json`.
    3. **Monitor**: Poll worker logs and task status every 10-15s.
    4. **Synthesize**: Combine worker outputs into `results.md`.
    5. **Terminate**: When done, set `"session_status": "complete"` in `tasks.json`.

    Announce: "Queen (Gemini 3.0 Pro) initialized for session {SESSION_ID}. I have {WORKER_COUNT} workers ready. What task should we work on?"
    ```

3.  **`worker-{N}-prompt.md`**:
    (Create one file for each worker 1..N. Use the standard worker prompts defined in the original instruction, but ensure they know to wait for the Queen's assignments.)

4.  **`.hive/mprocs.yaml`**:
    Generate the configuration. **IMPORTANT: The Queen must use the Gemini CLI.**

    ```yaml
    # mprocs configuration for Hive session: {SESSION_ID}
    procs:
      queen:
        cmd: ["powershell", "-NoProfile", "-Command", "gemini -m gemini-3.0-pro-preview -y -i 'You are the QUEEN. Read .hive/sessions/{SESSION_ID}/queen-prompt.md'"]
        cwd: "C:\\Users\\USERNAME"
        env:
          HIVE_ROLE: "queen"
          HIVE_SESSION: ".hive/sessions/{SESSION_ID}"

      worker-1-backend:
        cmd: ["claude", "--model", "opus", "--dangerously-skip-permissions", "You are WORKER 1. Read .hive/sessions/{SESSION_ID}/worker-1-prompt.md"]
        cwd: "C:\\Users\\USERNAME"
        env:
          HIVE_ROLE: "worker"
          HIVE_WORKER_ID: "1"

      worker-2-frontend:
        cmd: ["powershell", "-NoProfile", "-Command", "gemini -m gemini-2.0-flash-thinking-exp-01-21 -y -i 'You are WORKER 2. Read .hive/sessions/{SESSION_ID}/worker-2-prompt.md'"]
        cwd: "C:\\Users\\USERNAME"
        env:
          HIVE_ROLE: "worker"
          HIVE_WORKER_ID: "2"

      worker-3-bugfix:
        cmd: ["powershell", "-NoProfile", "-Command", "codex --dangerously-bypass-approvals-and-sandbox -m gpt-4o 'You are WORKER 3. Read .hive/sessions/{SESSION_ID}/worker-3-prompt.md'"]
        cwd: "C:\\Users\\USERNAME"
        env:
          HIVE_ROLE: "worker"
          HIVE_WORKER_ID: "3"

      logs:
        cmd: ["powershell", "-Command", "while($true) { Get-ChildItem '.hive/sessions/{SESSION_ID}/*.log' -ErrorAction SilentlyContinue | ForEach-Object { Write-Host \"=== $($_.Name) ===\"; Get-Content $_ -Tail 10 }; Start-Sleep 3; Clear-Host }"]
        cwd: "C:\\Users\\USERNAME"
    ```

**Step 5: Launch**
- Run the launch command using `run_shell_command`:
  ```powershell
  Start-Process powershell -ArgumentList '-NoExit', '-Command', 'cd "C:\Users\USERNAME"; mprocs --config .hive/mprocs.yaml'
  ```

**Step 6: Report**
- Output a summary of the session ID, workers, and instructions.
'''