# Phase 5: Commit & PR (Queen Only)

## Overview

After integration passes, Queen commits all changes and creates PR. **Queen is the ONLY agent who pushes.**

---

## Prerequisites

- Phase 4 complete
- `state/integration-test-results.md` shows PASS
- All Planners show PLANNER_COMPLETE

---

## Step 5a: Curate Learnings (REQUIRED)

Before committing, Queen MUST extract and store learnings for future sessions.

### 1. Read All Planner Summaries

```powershell
Get-ChildItem '.swarm/sessions/{SESSION_ID}/tasks/planner-*/summary.md' | ForEach-Object {
    Write-Host "=== $($_.Directory.Name) ===" -ForegroundColor Cyan
    Get-Content $_.FullName
}
```

### 2. Read Integration Results

```powershell
Get-Content '.swarm/sessions/{SESSION_ID}/state/integration-review.md'
Get-Content '.swarm/sessions/{SESSION_ID}/state/integration-test-results.md'
```

### 3. Synthesize Key Insights

Identify:
- **What worked well** - Patterns, approaches, tools that succeeded
- **What was tricky** - Edge cases, gotchas, things that took multiple attempts
- **Cross-domain insights** - Integration lessons, coordination patterns
- **Bug patterns** - If fixing bugs, what caused them and how to prevent

### 4. Extract Keywords

From the task description and work done, extract 3-5 keywords for future searchability:
- Technical terms (auth, api, database, frontend)
- Patterns (refactor, migration, integration)
- Domains (user, payment, notification)

### 5. Append to Learnings

**If `.ai-docs/learnings.jsonl` exists**, append one JSON line:

```json
{"date":"{YYYY-MM-DD}","session":"{SESSION_ID}","task":"{TASK_DESCRIPTION}","outcome":"success","keywords":["{kw1}","{kw2}","{kw3}"],"insight":"{1-2 sentence key learning}","files_touched":["{file1.ts}","{file2.ts}"],"planners":{PLANNER_COUNT},"domains":["{DOMAIN_A}","{DOMAIN_B}"]}
```

**If resolving an issue**, also update `.ai-docs/bug-patterns.md` if applicable:

```markdown
## Issue #{ISSUE_NUMBER} - {ISSUE_TITLE}

**Root Cause**: {what caused the bug}
**Fix Pattern**: {how it was fixed}
**Prevention**: {how to avoid in future}
**Files**: {list}
```

### 6. Log Completion

```powershell
powershell -NoProfile -Command "Add-Content -Path '.swarm/sessions/{SESSION_ID}/logs/queen.log' -Value \"[$(Get-Date -Format 'HH:mm:ss')] QUEEN: Learnings curated and saved to .ai-docs/\""
```

---

## Step 5b: Commit

### Stage Changes

```bash
git add -A
```

### Commit Message Format

```bash
git commit -m "$(cat <<'EOF'
feat: {descriptive message}

{Summary of what was done}

Swarm Session: {SESSION_ID}
Planners: {PLANNER_COUNT}
- Planner A: {DOMAIN_A}
- Planner B: {DOMAIN_B}

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

### For Issue Resolution

```bash
git commit -m "$(cat <<'EOF'
fix: resolve issue #{ISSUE_NUMBER}

{Summary of changes}

Swarm Session: {SESSION_ID}
Planners: {PLANNER_COUNT}
- Planner A ({DOMAIN_A}): {summary}
- Planner B ({DOMAIN_B}): {summary}

Resolves #{ISSUE_NUMBER}

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

## Step 5c: Push

```bash
git push -u origin {BRANCH_NAME}
```

For issue branches:
```bash
git push -u origin issue/{ISSUE_NUMBER}-{slug}
```

---

## Step 5d: Create PR

### Standard PR

```bash
gh pr create --base {BASE_BRANCH} --title "{PR_TITLE}" --body "$(cat <<'EOF'
## Summary
{1-3 bullet points}

## Swarm Architecture
- **Queen**: Opus 4.5 (orchestration, integration, PR)
- **Planner A ({DOMAIN_A})**: Opus 4.5 + Workers
- **Planner B ({DOMAIN_B})**: Opus 4.5 + Workers

## Work Done
### {DOMAIN_A}
{summary from Planner A}

### {DOMAIN_B}
{summary from Planner B}

## Integration
{summary from integration review}

## Test Results
All tests passing.

---
Session: {SESSION_ID}
Generated by Swarm multi-agent system
EOF
)"
```

### Issue Resolution PR

```bash
gh pr create --base {BASE_BRANCH} --title "fix: {ISSUE_TITLE}" --body "$(cat <<'EOF'
## Summary
Resolves #{ISSUE_NUMBER}

## Validated Concerns
{list concerns that were addressed}

## Swarm Architecture
- **Queen**: Opus 4.5
- **Planners**: {COUNT}

## Domain Work
{summaries from each Planner}

## Integration Review
{summary}

---
Session: {SESSION_ID}
EOF
)"
```

---

## Step 5e: Log Completion

```powershell
powershell -NoProfile -Command "Add-Content -Path '.swarm/sessions/{SESSION_ID}/logs/queen.log' -Value \"[$(Get-Date -Format 'HH:mm:ss')] QUEEN: PR created. Session complete.\""
```

---

## Phase 5 Complete

- Changes committed
- Branch pushed
- PR created
- Learnings captured

**Session is complete.** Queen can now monitor PR for external review comments and spawn code-quality agents if needed.
